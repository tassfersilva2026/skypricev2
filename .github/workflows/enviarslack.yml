name: send-drive-to-slack

on:
  schedule:
    - cron: "*/30 * * * *"  # a cada 30 minutos
  workflow_dispatch:

permissions:
  contents: read

env:
  TZ: America/Sao_Paulo

jobs:
  send:
    runs-on: ubuntu-latest
    concurrency:
      group: send-drive-to-slack
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ensure state folder
        run: mkdir -p state

      # === grava SA JSON com segurança (não vaza nos logs) ===
      - name: Write Service Account JSON (safe heredoc)
        run: |
          cat > sa.json <<'JSON'
          ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          JSON

      - name: Validate sa.json
        run: |
          python - << 'PY'
          import json
          json.load(open('sa.json'))
          print("Service Account JSON OK")
          PY

      # === envia arquivos das pastas do Drive para o Slack ===
      - name: Send Drive PDFs + PNG pairs (VM+MB→PDF) to Slack
        env:
          SLACK_TOKEN:   ${{ secrets.SLACK_TOKEN }}      # mesmo token do seu ACERVO (xoxb-...)
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}    # mesmo Channel ID (C0XXXX...)
          PNG_FOLDER_ID: "1oFgYZpqLMGetirb8mpQTmgjeQ6zhZ7up"  # pasta PNG
          PDF_FOLDER_ID: "1xjqqwIcPciT14fjdYfsZut-UvwtVD-pe"  # pasta PDF
          CUTOVER_SP: "2025-08-26T14:00:00"                   # opcional (SP). remova se quiser tudo
          TZ_NAME: "America/Sao_Paulo"
          MAX_UPLOAD_MB: "100"                                # opcional (limite por arquivo)
        run: |
          python scripts/slack_send_drive_pairs.py

      # === limpeza ===
      - name: Cleanup secrets file
        if: always()
        run: rm -f sa.json || true
